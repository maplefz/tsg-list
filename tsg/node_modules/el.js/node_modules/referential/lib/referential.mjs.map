{"version":3,"file":"referential.mjs","sources":["../src/ref.coffee","../src/index.coffee"],"sourcesContent":["import isNumber     from 'es-is/number'\nimport isObject     from 'es-is/object'\nimport objectAssign from 'es-object-assign'\nimport observable   from 'riot-observable'\n\nnextId = do ->\n  ids = 0\n  -> ids++\n\nexport default class Ref\n  constructor: (@_value, @parent, @key) ->\n    @_cache    = {}\n    @_children = {}\n    @_numChildren = 0\n    @_id       = nextId()\n\n    if @parent?\n      @parent._children[@_id] = @\n      @parent._numChildren++\n    observable @\n    @\n\n  # Clear the cache\n  _mutate: (key) ->\n    # TODO: do something smarter with key rather than wiping out entire cache\n    @_cache = {}\n\n    # clear children as well\n    child._mutate() for id, child of @_children\n\n    @\n\n  # clear everything\n  clear: ()->\n    @_cache = {}\n\n    child.clear() for id, child of @_children\n    @_children = {}\n    @_numChildren = 0\n\n    #clear out the values\n    @_value = undefined\n\n    if @parent?\n      @parent.set @key, undefined\n\n  # Removes reference\n  destroy: () ->\n    child.destroy() for id, child of @_children\n    delete @_cache\n    delete @_children\n    @off '*'\n\n    if @parent\n      delete @parent._children[@_id]\n      @parent._numChildren--\n    @\n\n  # Get value of this or parent Ref\n  value: (state) ->\n    unless @parent\n      if state?\n        @_value = state\n      return @_value\n\n    if state?\n      @parent.set @key, state\n    else\n      @parent.get @key\n\n  # Get a ref to this or subtree\n  ref: (key) ->\n    unless key\n      return @\n\n    new Ref null, @, key\n\n  # Get state or subtree\n  get: (key) ->\n    unless key\n      @value()\n    else\n      return @_cache[key] if @_cache[key]\n      @_cache[key] = @index key\n\n  # Set value overwriting tree along way\n  set: (key, value) ->\n    # handle case of object\n    if isObject key\n      for k, v of key\n        @set k, v\n\n      return @\n\n    oldValue = @get key\n\n    @_mutate key\n\n    unless value?\n      # avoid strings/nulls etc being thrown into object assign\n      if isObject key\n        @value objectAssign @value(), key\n      # fall back to standard assignment by setting key to ull/undefined\n      else\n        @index key, value, false\n    else\n      @index key, value, false\n\n    # set event\n    @_triggerSet key, value, oldValue\n    @_triggerSetChildren key, value, oldValue\n    @\n\n  _triggerSetChildren: (key, value, oldValue) ->\n    return @ if @_numChildren == 0\n    key = key + ''\n    keyParts = key.split '.'\n    partialKey = ''\n    childKeys = []\n    regExps = {}\n\n    for i, keyPart of keyParts\n      if partialKey == ''\n        partialKey = keyPart\n      else\n        partialKey += '.' + keyPart\n      childKeys[i] = partialKey\n\n      regExps[partialKey] = new RegExp '^' + partialKey + '\\.?'\n\n    for id, child of @_children\n      if child.key in childKeys\n        childRemainderKey = key.replace regExps[child.key], ''\n        child.trigger 'set', childRemainderKey, value, oldValue\n        child._triggerSetChildren childRemainderKey, value, oldValue\n\n  _triggerSet: (key, value, oldValue) ->\n    @trigger 'set', key, value, oldValue\n    if @parent\n      parentKey = @key + '.' + key\n      @parent._triggerSet parentKey, value, oldValue\n\n  # Deep set some value\n  extend: (key, value) ->\n    @_mutate key\n\n    unless value?\n      @value objectAssign @value(), key\n    else\n      if isObject value\n        @value objectAssign (@ref key).get(), value\n      else\n        clone = @clone()\n        @set key, value\n        @value objectAssign clone.get(), @value()\n    @\n\n  clone: (key) ->\n    new Ref objectAssign {}, @get key\n\n  # Walk tree using key, optionally update value\n  index: (key, value, get=true, obj=@value()) ->\n    if @parent\n      return @parent.index @key + '.' + key, value, get\n\n    if isNumber key\n      key = String key\n\n    props = key.split '.'\n\n    if get\n      # Get is simple, doesn't need to create properties as it goes\n      while prop = props.shift()\n        unless props.length\n          return obj?[prop]\n        obj = obj?[prop]\n      return\n\n    if !@_value?\n      @_value = {}\n      if !obj?\n        obj = @_value\n\n    # Set version creates tree if necessary\n    while prop = props.shift()\n      unless props.length\n        return obj[prop] = value\n      else\n        next = props[0]\n        unless obj[prop]?\n          if isNaN Number next\n            obj[prop] ?= {}\n          else\n            obj[prop] ?= []\n      obj = obj[prop]\n    return\n","import Ref from './ref'\n\nmethods = [\n  'extend'\n  'get'\n  'index'\n  'ref'\n  'set'\n  'value'\n  'clear'\n  'destroy'\n\n  'on'\n  'off'\n  'one'\n  'trigger'\n]\n\nrefer = (state, ref=null) ->\n  ref ?= new Ref state\n\n  wrapper = (key) -> ref.get key\n\n  for method in methods\n    do (method) ->\n      wrapper[method] = ->\n        ref[method].apply ref, arguments\n\n  wrapper.refer = (key) -> refer null, ref.ref key\n  wrapper.clone = (key) -> refer null, ref.clone key\n  wrapper\n\nrefer.Ref = Ref\n\nexport default refer\n"],"names":["Ref"],"mappings":"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"}